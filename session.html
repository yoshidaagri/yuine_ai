<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†åˆçŸ¥AI ã‚»ãƒƒã‚·ãƒ§ãƒ³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 50%, #ffffff 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(25, 118, 210, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e88e5 0%, #1976d2 50%, #1565c0 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }
        
        .header h1, .header p, .session-info {
            position: relative;
            z-index: 2;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .session-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            backdrop-filter: blur(5px);
        }
        
        .session-theme {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .session-timer {
            font-size: 16px;
            font-weight: 600;
            color: #ffeb3b;
        }
        
        .content {
            padding: 30px;
        }
        
        .progress-bar {
            background: #e3f2fd;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #1e88e5 0%, #1976d2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .question-section {
            background: linear-gradient(135deg, #f3f8ff 0%, #ffffff 100%);
            border: 1px solid rgba(25, 118, 210, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.08);
            display: none;
        }
        
        .question-section.active {
            display: block;
            animation: slideInUp 0.5s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .question-number {
            background: linear-gradient(135deg, #1e88e5 0%, #1976d2 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }
        
        .question-type {
            color: #1565c0;
            font-size: 14px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .question-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .input-area {
            margin-bottom: 20px;
        }
        
        .input-area label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        .input-area textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
        
        .ai-response {
            background: rgba(25, 118, 210, 0.05);
            border-left: 4px solid #1976d2;
            border-radius: 0 8px 8px 0;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .ai-response.show {
            display: block;
            animation: slideInDown 0.5s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-response h4 {
            color: #1565c0;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .ai-response-text {
            color: #333;
            line-height: 1.6;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .btn {
            background: linear-gradient(135deg, #1e88e5 0%, #1976d2 50%, #1565c0 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .btn:hover::before {
            transform: translateX(0);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.3);
        }
        
        .btn:disabled {
            background: linear-gradient(135deg, #90a4ae 0%, #78909c 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 50%, #2196f3 100%);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid rgba(25, 118, 210, 0.1);
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
            border: 1px solid rgba(198, 40, 40, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            display: none;
            font-weight: 500;
            box-shadow: 0 2px 12px rgba(198, 40, 40, 0.1);
        }
        
        .error.show {
            display: block;
        }
        
        .completion-screen {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        
        .completion-screen.show {
            display: block;
            animation: slideInUp 0.5s ease-out;
        }
        
        .completion-icon {
            font-size: 64px;
            color: #4caf50;
            margin-bottom: 20px;
        }
        
        .completion-title {
            font-size: 24px;
            color: #1565c0;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .completion-message {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .participant-name-section {
            background: linear-gradient(135deg, #f3f8ff 0%, #ffffff 100%);
            border: 1px solid rgba(25, 118, 210, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .participant-name-section h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }
        
        .participant-name-input {
            max-width: 300px;
            margin: 0 auto 20px;
        }
        
        .participant-name-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            transition: border-color 0.3s;
        }
        
        .participant-name-input input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .question-section {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>é›†åˆçŸ¥AI ã‚»ãƒƒã‚·ãƒ§ãƒ³</h1>
            <p>AIã¨å¯¾è©±ã—ã¦æ„è¦‹ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†</p>
            
            <div class="session-info">
                <div class="session-theme" id="sessionTheme">ãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                <div class="session-timer" id="sessionTimer">æ®‹ã‚Šæ™‚é–“: 05:00</div>
            </div>
        </div>
        
        <div class="content">
            <!-- å‚åŠ è€…åå…¥åŠ› -->
            <div id="participantNameSection" class="participant-name-section">
                <h3>å‚åŠ è€…æƒ…å ±</h3>
                <div class="participant-name-input">
                    <input type="text" id="participantName" placeholder="ã‚ãªãŸã®åå‰ï¼ˆåŒ¿åå¯ï¼‰" maxlength="50">
                </div>
                <button class="btn btn-success" id="startSessionBtn">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</button>
            </div>
            
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
            <div class="progress-bar" style="display: none;" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
            <div id="error" class="error"></div>
            
            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p id="loadingText">AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­...</p>
            </div>
            
            <!-- è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè³ªå•1ï¼‰ -->
            <div id="question1Section" class="question-section">
                <div class="question-header">
                    <div class="question-number">1</div>
                    <div>
                        <div class="question-type">å®šå‹è³ªå•1: åŸºæœ¬çš„ãªç«‹å ´ãƒ»æ„è¦‹</div>
                    </div>
                </div>
                <div class="question-text" id="question1Text">è³ªå•ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                
                <div class="input-area">
                    <label for="answer1">ã‚ãªãŸã®å›ç­”:</label>
                    <textarea id="answer1" placeholder="ã‚ãªãŸã®è€ƒãˆã‚„æ„è¦‹ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                </div>
                
                <div class="ai-response" id="aiResponse1">
                    <h4>ğŸ’¡ AIã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>
                    <div class="ai-response-text" id="aiResponseText1"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="getAiFeedback1">AIã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ±‚ã‚ã‚‹</button>
                    <button class="btn" id="nextQuestion1" disabled>æ¬¡ã®è³ªå•ã¸</button>
                </div>
            </div>
            
            <!-- è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè³ªå•2ï¼‰ -->
            <div id="question2Section" class="question-section">
                <div class="question-header">
                    <div class="question-number">2</div>
                    <div>
                        <div class="question-type">å®šå‹è³ªå•2: å…·ä½“çš„ãªçµŒé¨“ãƒ»äº‹ä¾‹</div>
                    </div>
                </div>
                <div class="question-text" id="question2Text">è³ªå•ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                
                <div class="input-area">
                    <label for="answer2">ã‚ãªãŸã®å›ç­”:</label>
                    <textarea id="answer2" placeholder="å…·ä½“çš„ãªçµŒé¨“ã‚„äº‹ä¾‹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„..."></textarea>
                </div>
                
                <div class="ai-response" id="aiResponse2">
                    <h4>ğŸ’¡ AIã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>
                    <div class="ai-response-text" id="aiResponseText2"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="getAiFeedback2">AIã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ±‚ã‚ã‚‹</button>
                    <button class="btn" id="nextQuestion2" disabled>æ¬¡ã®è³ªå•ã¸</button>
                </div>
            </div>
            
            <!-- è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ·±æ˜ã‚Šè³ªå•ï¼‰ -->
            <div id="question3Section" class="question-section">
                <div class="question-header">
                    <div class="question-number">3</div>
                    <div>
                        <div class="question-type">æ·±æ˜ã‚Šè³ªå•: AIå¯¾è©±ã§è­°è«–ã‚’æ·±ã‚ã‚‹</div>
                    </div>
                </div>
                <div class="question-text" id="question3Text">è³ªå•ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                
                <div class="input-area">
                    <label for="answer3">ã‚ãªãŸã®å›ç­”:</label>
                    <textarea id="answer3" placeholder="è‡ªç”±ã«è­°è«–ã‚’æ·±ã‚ã¦ãã ã•ã„..."></textarea>
                </div>
                
                <div class="ai-response" id="aiResponse3">
                    <h4>ğŸ’¡ AIã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>
                    <div class="ai-response-text" id="aiResponseText3"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="getAiFeedback3">AIã¨è­°è«–ã‚’ç¶šã‘ã‚‹</button>
                    <button class="btn btn-success" id="completeSession" disabled>ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†</button>
                </div>
            </div>
            
            <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ç”»é¢ -->
            <div id="completionScreen" class="completion-screen">
                <div class="completion-icon">ğŸ‰</div>
                <div class="completion-title">ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼</div>
                <div class="completion-message">
                    ã”å‚åŠ ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>
                    ã‚ãªãŸã®æ„è¦‹ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çµæœã«åæ˜ ã•ã‚Œã¾ã™ã€‚
                </div>
                <button class="btn btn-secondary" onclick="window.close()">ç”»é¢ã‚’é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        const DEBUG_SESSION = {
            log: (message, data = null) => {
                const timestamp = new Date().toLocaleString('ja-JP');
                console.log(`[SESSION ${timestamp}] ${message}`);
                if (data) console.log('ãƒ‡ãƒ¼ã‚¿:', data);
            },
            error: (message, error = null) => {
                const timestamp = new Date().toLocaleString('ja-JP');
                console.error(`[SESSION ERROR ${timestamp}] ${message}`);
                if (error) console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            }
        };
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let sessionId = null;
        let participantId = null;
        let currentQuestion = 0;
        let questions = [];
        let sessionTimer = null;
        let timeRemaining = 300; // 5åˆ† = 300ç§’
        let sessionData = {
            theme: '',
            answers: [],
            aiResponses: []
        };
        
        DEBUG_SESSION.log('session.htmlèª­ã¿è¾¼ã¿é–‹å§‹');
        
        // DOMè¦ç´ 
        const elements = {
            participantNameSection: document.getElementById('participantNameSection'),
            participantName: document.getElementById('participantName'),
            startSessionBtn: document.getElementById('startSessionBtn'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            sessionTheme: document.getElementById('sessionTheme'),
            sessionTimer: document.getElementById('sessionTimer'),
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loadingText'),
            error: document.getElementById('error'),
            completionScreen: document.getElementById('completionScreen'),
            
            // è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            question1Section: document.getElementById('question1Section'),
            question2Section: document.getElementById('question2Section'),
            question3Section: document.getElementById('question3Section'),
            
            // è³ªå•ãƒ†ã‚­ã‚¹ãƒˆ
            question1Text: document.getElementById('question1Text'),
            question2Text: document.getElementById('question2Text'),
            question3Text: document.getElementById('question3Text'),
            
            // å›ç­”å…¥åŠ›
            answer1: document.getElementById('answer1'),
            answer2: document.getElementById('answer2'),
            answer3: document.getElementById('answer3'),
            
            // AIå¿œç­”
            aiResponse1: document.getElementById('aiResponse1'),
            aiResponse2: document.getElementById('aiResponse2'),
            aiResponse3: document.getElementById('aiResponse3'),
            aiResponseText1: document.getElementById('aiResponseText1'),
            aiResponseText2: document.getElementById('aiResponseText2'),
            aiResponseText3: document.getElementById('aiResponseText3'),
            
            // ãƒœã‚¿ãƒ³
            getAiFeedback1: document.getElementById('getAiFeedback1'),
            getAiFeedback2: document.getElementById('getAiFeedback2'),
            getAiFeedback3: document.getElementById('getAiFeedback3'),
            nextQuestion1: document.getElementById('nextQuestion1'),
            nextQuestion2: document.getElementById('nextQuestion2'),
            completeSession: document.getElementById('completeSession')
        };
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            DEBUG_SESSION.log('DOMèª­ã¿è¾¼ã¿å®Œäº†');
            try {
                initializeSession();
                setupEventListeners();
                DEBUG_SESSION.log('åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                DEBUG_SESSION.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', error);
                showError('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã«ç·Šæ€¥è¡¨ç¤º
                document.body.innerHTML = `
                    <div style="padding: 20px; color: red; background: #ffe6e6; border: 1px solid red; margin: 20px;">
                        <h2>åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2>
                        <p><strong>ã‚¨ãƒ©ãƒ¼å†…å®¹:</strong> ${error.message}</p>
                        <p><strong>URL:</strong> ${window.location.href}</p>
                        <p><strong>æ™‚åˆ»:</strong> ${new Date().toLocaleString()}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
        window.addEventListener('error', function(event) {
            DEBUG_SESSION.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼', event.error);
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: red; color: white; padding: 10px; z-index: 9999;';
            errorDiv.innerHTML = `JavaScript ã‚¨ãƒ©ãƒ¼: ${event.message} (${event.filename}:${event.lineno})`;
            document.body.appendChild(errorDiv);
        });
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        function initializeSession() {
            DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
            
            try {
                // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
                const serverSessionId = '<?= sessionId ?>';
                const serverParams = '<?= pageParams ?>';
                
                // serverParamsã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆJSONæ–‡å­—åˆ—ã®å ´åˆï¼‰
                let parsedServerParams = {};
                try {
                    parsedServerParams = serverParams ? JSON.parse(serverParams) : {};
                } catch (e) {
                    DEBUG_SESSION.warn('serverParamsã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—', { serverParams, error: e.message });
                }
                
                DEBUG_SESSION.log('ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª', {
                    serverSessionId,
                    serverParams,
                    parsedServerParams,
                    href: window.location.href
                });
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
                if (serverSessionId && serverSessionId !== '') {
                    sessionId = serverSessionId;
                    DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå–å¾—æˆåŠŸï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼‰', { sessionId });
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
                    DEBUG_SESSION.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ');
                    const urlParams = new URLSearchParams(window.location.search);
                    sessionId = urlParams.get('sessionId');
                    
                    DEBUG_SESSION.log('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª', {
                        search: window.location.search,
                        sessionId,
                        allParams: Object.fromEntries(urlParams)
                    });
                }
                
                if (!sessionId || sessionId === '') {
                    DEBUG_SESSION.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    showError('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    document.getElementById('sessionTheme').textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒæœªè¨­å®š';
                    return;
                }
                
                // å‚åŠ è€…IDã‚’ç”Ÿæˆ
                participantId = 'participant_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                DEBUG_SESSION.log('å‚åŠ è€…IDç”Ÿæˆ', { participantId });
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
                DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±èª­ã¿è¾¼ã¿é–‹å§‹');
                loadSessionInfo();
                
            } catch (error) {
                DEBUG_SESSION.error('initializeSessionå†…ã‚¨ãƒ©ãƒ¼', error);
                showError('ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
                throw error;
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            elements.startSessionBtn.addEventListener('click', startSession);
            
            // AI ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³
            elements.getAiFeedback1.addEventListener('click', () => getAiFeedback(1));
            elements.getAiFeedback2.addEventListener('click', () => getAiFeedback(2));
            elements.getAiFeedback3.addEventListener('click', () => getAiFeedback(3));
            
            // æ¬¡ã®è³ªå•ãƒœã‚¿ãƒ³
            elements.nextQuestion1.addEventListener('click', () => moveToQuestion(2));
            elements.nextQuestion2.addEventListener('click', () => moveToQuestion(3));
            elements.completeSession.addEventListener('click', completeSession);
            
            // å›ç­”å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            elements.answer1.addEventListener('input', () => validateAnswer(1));
            elements.answer2.addEventListener('input', () => validateAnswer(2));
            elements.answer3.addEventListener('input', () => validateAnswer(3));
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±èª­ã¿è¾¼ã¿
        function loadSessionInfo() {
            DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±èª­ã¿è¾¼ã¿é–‹å§‹', { sessionId });
            showLoading(true, 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            
            try {
                // google.script.runã®å­˜åœ¨ç¢ºèª
                if (typeof google === 'undefined' || !google.script || !google.script.run) {
                    DEBUG_SESSION.error('google.script.runãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    showError('Google Apps Script API ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚WebAppç’°å¢ƒã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                DEBUG_SESSION.log('google.script.runå‘¼ã³å‡ºã—é–‹å§‹', { sessionId });
                google.script.run
                    .withSuccessHandler(handleSessionInfoLoaded)
                    .withFailureHandler(handleError)
                    .getSessionInfo(sessionId);
                DEBUG_SESSION.log('google.script.runå‘¼ã³å‡ºã—å®Œäº†');
                
            } catch (error) {
                DEBUG_SESSION.error('google.script.runå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼', error);
                showError('APIã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ' + error.message);
                showLoading(false);
            }
        }
        
        function handleSessionInfoLoaded(sessionInfo) {
            DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å—ä¿¡', sessionInfo);
            showLoading(false);
            
            if (!sessionInfo || !sessionInfo.success) {
                DEBUG_SESSION.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—å¤±æ•—', sessionInfo);
                showError('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (sessionInfo?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                return;
            }
            
            sessionData.theme = sessionInfo.theme;
            questions = sessionInfo.questions;
            
            DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿è¨­å®š', { 
                theme: sessionData.theme, 
                questions: questions,
                questionsType: typeof questions,
                questionsLength: questions ? questions.length : 'null',
                question0: questions ? questions[0] : 'null',
                question1: questions ? questions[1] : 'null',
                question2: questions ? questions[2] : 'null'
            });
            
            elements.sessionTheme.textContent = sessionInfo.theme;
            
            // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
            DEBUG_SESSION.log('DOMè¦ç´ ç¢ºèª', {
                question1Text: !!elements.question1Text,
                question2Text: !!elements.question2Text,
                question3Text: !!elements.question3Text
            });
            
            // è³ªå•ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
            try {
                if (elements.question1Text) {
                    elements.question1Text.textContent = questions[0] || 'è³ªå•1ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ';
                    DEBUG_SESSION.log('è³ªå•1è¨­å®šå®Œäº†', { text: elements.question1Text.textContent });
                }
                
                if (elements.question2Text) {
                    elements.question2Text.textContent = questions[1] || 'è³ªå•2ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ';
                    DEBUG_SESSION.log('è³ªå•2è¨­å®šå®Œäº†', { text: elements.question2Text.textContent });
                }
                
                if (elements.question3Text) {
                    elements.question3Text.textContent = questions[2] || 'è³ªå•3ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ';
                    DEBUG_SESSION.log('è³ªå•3è¨­å®šå®Œäº†', { text: elements.question3Text.textContent });
                }
            } catch (error) {
                DEBUG_SESSION.error('è³ªå•ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼', error);
                showError('è³ªå•ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
            
            DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±è¨­å®šå®Œäº†');
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
        function startSession() {
            const name = elements.participantName.value.trim();
            if (!name) {
                showError('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // UIåˆ‡ã‚Šæ›¿ãˆ
            elements.participantNameSection.style.display = 'none';
            elements.progressBar.style.display = 'block';
            elements.question1Section.classList.add('active');
            
            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            startTimer();
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
            updateProgress();
        }
        
        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            sessionTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(sessionTimer);
                    autoCompleteSession();
                }
            }, 1000);
        }
        
        // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºæ›´æ–°
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            elements.sessionTimer.textContent = `æ®‹ã‚Šæ™‚é–“: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªããªã£ãŸã‚‰è‰²ã‚’å¤‰ãˆã‚‹
            if (timeRemaining <= 60) {
                elements.sessionTimer.style.color = '#ff5722';
            } else if (timeRemaining <= 120) {
                elements.sessionTimer.style.color = '#ff9800';
            }
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        function updateProgress() {
            const progress = (currentQuestion / 3) * 100;
            elements.progressFill.style.width = progress + '%';
        }
        
        // è³ªå•ç§»å‹•
        function moveToQuestion(questionNumber) {
            // å‰ã®è³ªå•ã®å›ç­”ã‚’å¼·åˆ¶çš„ã«ä¿å­˜ï¼ˆAIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšï¼‰
            const previousQuestionNumber = questionNumber - 1;
            if (previousQuestionNumber >= 1 && previousQuestionNumber <= 3) {
                const previousAnswer = elements[`answer${previousQuestionNumber}`].value.trim();
                if (previousAnswer) {
                    sessionData.answers[previousQuestionNumber - 1] = previousAnswer;
                    DEBUG_SESSION.log('è³ªå•ç§»å‹•æ™‚ã®å›ç­”ä¿å­˜', {
                        questionNumber: previousQuestionNumber,
                        answerLength: previousAnswer.length,
                        hasAiResponse: !!sessionData.aiResponses[previousQuestionNumber - 1]
                    });
                }
            }
            
            // ç¾åœ¨ã®è³ªå•ã‚’éè¡¨ç¤º
            document.querySelector('.question-section.active').classList.remove('active');
            
            // æ¬¡ã®è³ªå•ã‚’è¡¨ç¤º
            currentQuestion = questionNumber - 1;
            const nextSection = document.getElementById(`question${questionNumber}Section`);
            nextSection.classList.add('active');
            
            updateProgress();
        }
        
        // å›ç­”æ¤œè¨¼
        function validateAnswer(questionNumber) {
            const answer = elements[`answer${questionNumber}`].value.trim();
            const nextBtn = questionNumber < 3 ? 
                elements[`nextQuestion${questionNumber}`] : 
                elements.completeSession;
            
            nextBtn.disabled = answer.length < 10; // æœ€ä½10æ–‡å­—
        }
        
        // AI ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—
        function getAiFeedback(questionNumber) {
            const answer = elements[`answer${questionNumber}`].value.trim();
            
            if (answer.length < 10) {
                showError('å›ç­”ã¯10æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            showLoading(true, 'AIãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆä¸­...');
            
            const data = {
                sessionId: sessionId,
                participantId: participantId,
                questionNumber: questionNumber,
                question: questions[questionNumber - 1],
                answer: answer,
                theme: sessionData.theme
            };
            
            google.script.run
                .withSuccessHandler((response) => handleAiFeedback(questionNumber, response))
                .withFailureHandler(handleError)
                .getAiFeedbackForAnswer(data);
        }
        
        function handleAiFeedback(questionNumber, response) {
            showLoading(false);
            
            if (response && response.success) {
                const aiResponse = elements[`aiResponse${questionNumber}`];
                const aiResponseText = elements[`aiResponseText${questionNumber}`];
                
                aiResponseText.textContent = response.feedback;
                aiResponse.classList.add('show');
                
                // å›ç­”ã‚’ä¿å­˜
                sessionData.answers[questionNumber - 1] = elements[`answer${questionNumber}`].value.trim();
                sessionData.aiResponses[questionNumber - 1] = response.feedback;
                
                // æ¬¡ã¸é€²ã‚€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                if (questionNumber < 3) {
                    elements[`nextQuestion${questionNumber}`].disabled = false;
                } else {
                    elements.completeSession.disabled = false;
                }
            } else {
                showError('AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†
        function completeSession() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«è¨­å®šï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†è¡¨ç¤ºï¼‰
            elements.progressFill.style.width = '100%';
            
            showLoading(true, 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Œäº†ä¸­...');
            
            // å…¨ã¦ã®å›ç­”ã‚’å¼·åˆ¶çš„ã«åé›†ï¼ˆAIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšï¼‰
            sessionData.answers[0] = elements.answer1.value.trim();
            sessionData.answers[1] = elements.answer2.value.trim();
            sessionData.answers[2] = elements.answer3.value.trim();
            
            // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãªã„å ´åˆã¯ç©ºæ–‡å­—åˆ—ã§åŸ‹ã‚ã‚‹
            for (let i = 0; i < 3; i++) {
                if (!sessionData.aiResponses[i]) {
                    sessionData.aiResponses[i] = '';
                }
            }
            
            DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ãƒ‡ãƒ¼ã‚¿åé›†', {
                sessionId: sessionId,
                participantId: participantId,
                answers: sessionData.answers.map((answer, i) => ({
                    questionNumber: i + 1,
                    hasAnswer: !!answer && answer.trim() !== '',
                    answerLength: answer ? answer.length : 0,
                    hasAiResponse: !!sessionData.aiResponses[i] && sessionData.aiResponses[i].trim() !== ''
                })),
                totalAnswers: sessionData.answers.filter(a => a && a.trim() !== '').length
            });
            
            const completionData = {
                sessionId: sessionId,
                participantId: participantId,
                participantName: elements.participantName.value.trim(),
                theme: sessionData.theme,
                answers: sessionData.answers,
                aiResponses: sessionData.aiResponses
            };
            
            google.script.run
                .withSuccessHandler(handleSessionCompleted)
                .withFailureHandler(handleError)
                .saveSessionResults(completionData);
        }
        
        function handleSessionCompleted(result) {
            DEBUG_SESSION.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†çµæœå—ä¿¡', {
                success: result ? result.success : false,
                message: result ? result.message : 'no result',
                savedCount: result ? result.savedCount : 'unknown',
                skippedCount: result ? result.skippedCount : 'unknown'
            });
            
            showLoading(false);
            
            if (result && result.success) {
                // ä¿å­˜çµæœã®è©³ç´°ã‚’ãƒ­ã‚°å‡ºåŠ›
                if (result.savedCount !== undefined && result.skippedCount !== undefined) {
                    DEBUG_SESSION.log('ä¿å­˜çµæœè©³ç´°', {
                        saved: result.savedCount,
                        skipped: result.skippedCount,
                        message: result.message
                    });
                    
                    // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸå›ç­”ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Š
                    if (result.skippedCount > 0) {
                        DEBUG_SESSION.warn(`${result.skippedCount}ä»¶ã®å›ç­”ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ`);
                    }
                }
                
                // è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                document.querySelector('.question-section.active').classList.remove('active');
                
                // å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
                elements.completionScreen.classList.add('show');
            } else {
                DEBUG_SESSION.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†å¤±æ•—', {
                    result: result,
                    message: result ? result.message : 'no result'
                });
                showError('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result ? result.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            }
        }
        
        // è‡ªå‹•å®Œäº†ï¼ˆæ™‚é–“åˆ‡ã‚Œï¼‰
        function autoCompleteSession() {
            showError('åˆ¶é™æ™‚é–“ã«ãªã‚Šã¾ã—ãŸã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•å®Œäº†ã—ã¾ã™ã€‚');
            setTimeout(completeSession, 2000);
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showLoading(show, text = 'AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­...') {
            elements.loading.classList.toggle('show', show);
            if (text) {
                elements.loadingText.textContent = text;
            }
        }
        
        function showError(message) {
            elements.error.textContent = message;
            elements.error.classList.add('show');
            setTimeout(() => elements.error.classList.remove('show'), 5000);
        }
        
        function handleError(error) {
            showLoading(false);
            showError(error.toString());
        }
        
        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã®ç¢ºèª
        window.addEventListener('beforeunload', function(e) {
            if (currentQuestion > 0 && !elements.completionScreen.classList.contains('show')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>